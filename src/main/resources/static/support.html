<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motorverse - Support</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Add these styles to the existing ones */
        .overflow-y-auto {
            scrollbar-width: thin;
            scrollbar-color: rgba(100, 116, 139, 0.5) transparent;
        }
        
        .overflow-y-auto::-webkit-scrollbar {
            width: 6px;
        }
        
        .overflow-y-auto::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background-color: rgba(100, 116, 139, 0.5);
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans min-h-screen flex flex-col">
    <!-- Navigation Bar -->
    <nav class="bg-gray-800 p-4 sticky top-0 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold transition-colors duration-300 hover:text-blue-400">Motorverse</h1>
            <div class="hidden md:flex space-x-6">
                <a href="index.html" class="hover:text-blue-400 transition-colors duration-200">Home</a>
                <a href="buy-car.html" class="hover:text-blue-400 transition-colors duration-200">Buy a Car</a>
                <a href="rent-car.html" class="hover:text-blue-400 transition-colors duration-200">Rent a Car</a>
                <a href="support.html" class="text-blue-400 transition-colors duration-200">Support</a>
                <a href="register.html" class="hover:text-blue-400 transition-colors duration-200">Register</a>
            </div>
            <button id="menu-toggle" class="md:hidden text-white focus:outline-none hover:text-blue-400 transition-colors duration-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                </svg>
            </button>
        </div>
        <div id="mobile-menu" class="hidden md:hidden mt-2 bg-gray-800 p-2 rounded-b-lg">
            <a href="index.html" class="block py-2 hover:text-blue-400 transition-colors duration-200">Home</a>
            <a href="buy-car.html" class="block py-2 hover:text-blue-400 transition-colors duration-200">Buy a Car</a>
            <a href="rent-car.html" class="block py-2 hover:text-blue-400 transition-colors duration-200">Rent a Car</a>
            <a href="support.html" class="block py-2 text-blue-400 transition-colors duration-200">Support</a>
            <a href="register.html" class="block py-2 hover:text-blue-400 transition-colors duration-200">Register</a>
        </div>
    </nav>

    <main class="flex-grow container mx-auto p-6">
        <h1 class="text-4xl font-bold text-center mb-8">Customer Support</h1>

        <!-- Login Required Message -->
        <div id="login-required" class="hidden bg-red-900 p-6 rounded-lg shadow-lg text-center mb-8 max-w-2xl mx-auto">
            <h2 class="text-xl font-semibold mb-4">Please Login First</h2>
            <p class="text-gray-300 mb-4">You need to be logged in to create support tickets.</p>
            <a href="login.html" class="inline-block bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-full transition-all duration-200">Login Now</a>
        </div>

        <!-- Create Ticket Form -->
        <div id="create-ticket" class="hidden bg-gray-800 p-6 rounded-lg shadow-lg mb-8 max-w-2xl mx-auto">
            <h2 class="text-2xl font-semibold mb-6">Create New Support Ticket</h2>
            <form id="ticket-form" class="space-y-4">
                <div>
                    <label for="issue-title" class="block text-sm font-medium mb-2">Issue Title</label>
                    <input type="text" id="issue-title" name="issue-title" required
                        class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="description" class="block text-sm font-medium mb-2">Description</label>
                    <textarea id="description" name="description" rows="4" required
                        class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div class="flex justify-center">
                    <button type="submit" 
                        class="px-8 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-full transition-colors duration-200">
                        Submit Ticket
                    </button>
                </div>
            </form>
        </div>

        <!-- Ticket History -->
        <div id="ticket-history" class="hidden max-w-full mx-auto">
            <!-- Two Column Layout for Open and In Progress -->
            <div class="flex flex-col md:flex-row gap-8 mb-8">
                <!-- Open Tickets Panel -->
                <div class="bg-gray-800 rounded-lg shadow-lg flex-1">
                    <h2 class="text-2xl font-semibold p-6 border-b border-gray-700">Open Tickets</h2>
                    <div id="open-tickets" class="space-y-4 overflow-y-auto max-h-[400px] p-4">
                        <!-- Open tickets will be loaded here -->
                    </div>
                </div>

                <!-- In Progress Tickets Panel -->
                <div class="bg-gray-800 rounded-lg shadow-lg flex-1">
                    <h2 class="text-2xl font-semibold p-6 border-b border-gray-700">In Progress Tickets</h2>
                    <div id="progress-tickets" class="space-y-4 overflow-y-auto max-h-[400px] p-4">
                        <!-- In Progress tickets will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Full Width Completed Tickets Panel -->
            <div class="bg-gray-800 rounded-lg shadow-lg w-full">
                <h2 class="text-2xl font-semibold p-6 border-b border-gray-700">Resolved & Closed Tickets</h2>
                <div id="completed-tickets" class="space-y-4 overflow-y-auto max-h-[400px] p-4">
                    <!-- Resolved and Closed tickets will be loaded here -->
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 p-4 text-center shadow-inner">
        <p class="text-gray-300">Â© 2025 Motorverse</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const user = JSON.parse(localStorage.getItem('loggedInUser'));
            const userId = localStorage.getItem('userId');
            const loginRequired = document.getElementById('login-required');
            const createTicket = document.getElementById('create-ticket');
            const ticketHistory = document.getElementById('ticket-history');
            const ticketForm = document.getElementById('ticket-form');
            const ticketsContainer = document.getElementById('tickets-container');

            if (!user || !userId) {
                loginRequired.classList.remove('hidden');
                return;
            }

            // Show ticket form and history
            createTicket.classList.remove('hidden');
            ticketHistory.classList.remove('hidden');

            // Load ticket history
            loadTickets();

            // Handle ticket submission
            ticketForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const ticketData = {
                    userId: parseInt(userId),
                    issueTitle: document.getElementById('issue-title').value,
                    description: document.getElementById('description').value
                };

                try {
                    const response = await fetch('/api/support/tickets', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(ticketData)
                    });

                    if (!response.ok) throw new Error('Failed to create ticket');

                    alert('Support ticket created successfully!');
                    ticketForm.reset();
                    loadTickets(); // Reload tickets list
                } catch (error) {
                    console.error('Error creating ticket:', error);
                    alert('Failed to create support ticket. Please try again.');
                }
            });

            async function loadTickets() {
                try {
                    const response = await fetch(`/api/support/tickets/user/${userId}`);
                    if (!response.ok) throw new Error('Failed to load tickets');
                    
                    const tickets = await response.json();
                    renderTickets(tickets);
                } catch (error) {
                    console.error('Error loading tickets:', error);
                    ticketsContainer.innerHTML = '<p class="text-red-400">Failed to load tickets. Please try again later.</p>';
                }
            }

            function renderTickets(tickets) {
                const openTickets = tickets.filter(t => t.status === 'OPEN');
                const progressTickets = tickets.filter(t => t.status === 'IN_PROGRESS');
                const completedTickets = tickets.filter(t => ['RESOLVED', 'CLOSED'].includes(t.status))
                    .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));

                renderTicketGroup('open-tickets', openTickets, true);
                renderTicketGroup('progress-tickets', progressTickets, true);
                renderTicketGroup('completed-tickets', completedTickets, false);
            }

            function renderTicketGroup(containerId, tickets, requireConfirmation) {
                const container = document.getElementById(containerId);
                
                if (tickets.length === 0) {
                    container.innerHTML = '<p class="text-gray-400">No tickets found.</p>';
                    return;
                }

                container.innerHTML = tickets.map(ticket => `
                    <div class="bg-gray-700 p-4 rounded-lg">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-semibold">${ticket.issueTitle}</h3>
                            <span class="px-2 py-1 text-sm rounded ${getStatusClass(ticket.status)}">
                                ${formatStatus(ticket.status)}
                            </span>
                        </div>
                        <p class="text-gray-300 mb-2">${ticket.description}</p>
                        <div class="text-sm text-gray-400">
                            <p>Created: ${new Date(ticket.createdAt).toLocaleString()}</p>
                            ${ticket.resolution ? 
                                `<p class="mt-2"><strong>Resolution:</strong> ${ticket.resolution}</p>` : ''}
                        </div>
                        <button class="delete-ticket mt-4 px-4 py-2 bg-red-500 hover:bg-red-600 rounded text-sm"
                            data-ticket-id="${ticket.id}" 
                            data-confirm="${requireConfirmation}">
                            Delete Ticket
                        </button>
                    </div>
                `).join('');

                // Add delete handlers
                container.querySelectorAll('.delete-ticket').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const ticketId = e.target.dataset.ticketId;
                        const requireConfirm = e.target.dataset.confirm === 'true';

                        if (requireConfirm) {
                            const confirmed = confirm('Are you sure you want to delete this ticket?');
                            if (!confirmed) return;

                            const doubleConfirmed = confirm('Please confirm again that you want to delete this ticket.');
                            if (!doubleConfirmed) return;
                        } else if (!confirm('Are you sure you want to delete this ticket?')) {
                            return;
                        }

                        try {
                            const response = await fetch(`/api/support/tickets/${ticketId}`, {
                                method: 'DELETE'
                            });

                            if (!response.ok) throw new Error('Failed to delete ticket');
                            
                            loadTickets(); // Reload tickets after deletion
                        } catch (error) {
                            console.error('Error:', error);
                            alert('Failed to delete ticket');
                        }
                    });
                });
            }

            function getStatusClass(status) {
                switch(status) {
                    case 'OPEN': return 'bg-yellow-600';
                    case 'IN_PROGRESS': return 'bg-blue-600';
                    case 'RESOLVED': return 'bg-green-600';
                    case 'CLOSED': return 'bg-gray-600';
                    default: return 'bg-gray-600';
                }
            }

            function formatStatus(status) {
                return status.replace('_', ' ').toLowerCase()
                    .replace(/\b\w/g, c => c.toUpperCase());
            }
        });
    </script>
</body>
</html>
