<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motorverse - Payment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        .payment-toggle {
            transition: all 0.3s ease;
        }
        .payment-toggle.active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
        }
        .total-box {
            background: linear-gradient(135deg, #1f2937, #374151); /* gray-800 to gray-700 */
            border: 2px solid #60a5fa; /* blue-400 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans min-h-screen flex flex-col">
    <nav class="bg-gray-800 p-4 sticky top-0 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold transition-colors duration-300 hover:text-blue-400">Motorverse</h1>
            <div class="hidden md:flex space-x-6">
                <a href="index.html" class="hover:text-blue-400 transition-colors duration-200">Home</a>
                <a href="buy-car.html" class="hover:text-blue-400 transition-colors duration-200">Buy a Car</a>
                <a href="rent-car.html" class="hover:text-blue-400 transition-colors duration-200">Rent a Car</a>
                <a href="support.html" class="hover:text-blue-400 transition-colors duration-200">Support</a>
                <a href="register.html" class="hover:text-blue-400 transition-colors duration-200">Register</a>
            </div>
            <button id="menu-toggle" class="md:hidden text-white focus:outline-none hover:text-blue-400 transition-colors duration-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                </svg>
            </button>
        </div>
        <div id="mobile-menu" class="hidden md:hidden mt-2 bg-gray-800 p-2 rounded-b-lg">
            <a href="index.html" class="block py-2 hover:text-blue-400 transition-colors duration-200">Home</a>
            <a href="buy-car.html" class="block py-2 hover:text-blue-400 transition-colors duration-200">Buy a Car</a>
            <a href="rent-car.html" class="block py-2 hover:text-blue-400 transition-colors duration-200">Rent a Car</a>
            <a href="support.html" class="block py-2 hover:text-blue-400 transition-colors duration-200">Support</a>
            <a href="register.html" class="block py-2 hover:text-blue-400 transition-colors duration-200">Register</a>
        </div>
    </nav>

    <main class="flex-grow container mx-auto p-6">
        <h2 class="text-4xl font-bold text-center mb-8 fade-in">Complete Your Transaction</h2>
        <section class="bg-gray-800 rounded-xl shadow-lg p-8 max-w-2xl mx-auto fade-in">
            <div class="mb-6">
                <h3 id="vehicle-name" class="text-2xl font-semibold">Loading...</h3>
                <p id="vehicle-price" class="text-gray-300">Fetching details...</p>
                <p id="rental-days" class="text-gray-300 hidden"></p>
                
                <!-- Insurance Information Display -->
                <div id="insurance-info" class="mt-4 p-3 bg-gray-700 rounded-lg hidden">
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-medium text-green-400">Insurance Package:</h4>
                            <p id="insurance-name" class="text-gray-300"></p>
                        </div>
                        <p id="insurance-cost" class="text-lg font-semibold"></p>
                    </div>
                </div>
            </div>

            <div class="total-box p-4 rounded-lg mb-6">
                <p class="text-lg">Total Cost</p>
                <p id="total-cost" class="text-3xl font-bold text-blue-400">$0.00</p>
            </div>

            <div class="flex justify-center gap-4 mb-6">
                <button id="credit-card-toggle" class="payment-toggle px-4 py-2 bg-gray-700 rounded-full hover:bg-blue-500 transition-all duration-200 active">Credit Card</button>
                <button id="paypal-toggle" class="payment-toggle px-4 py-2 bg-gray-700 rounded-full hover:bg-blue-500 transition-all duration-200">PayPal</button>
                <button id="debit-card-toggle" class="payment-toggle px-4 py-2 bg-gray-700 rounded-full hover:bg-blue-500 transition-all duration-200">Debit Card</button>
            </div>

            <form id="payment-form" class="space-y-4">
                <div id="credit-card-form" class="payment-method-form">
                    <div class="mb-4">
                        <label class="block text-sm mb-2" for="card-number">Card Number</label>
                        <input type="text" id="card-number" name="card-number" class="w-full p-2 rounded bg-gray-700 text-white focus:ring-2 focus:ring-blue-500" placeholder="1234 5678 9012 3456">
                    </div>
                    <div class="flex gap-4 mb-4">
                        <div class="flex-1">
                            <label class="block text-sm mb-2" for="expiry">Expiry Date</label>
                            <input type="text" id="expiry" name="expiry" class="w-full p-2 rounded bg-gray-700 text-white focus:ring-2 focus:ring-blue-500" placeholder="MM/YY">
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm mb-2" for="cvv">CVV</label>
                            <input type="text" id="cvv" name="cvv" class="w-full p-2 rounded bg-gray-700 text-white focus:ring-2 focus:ring-blue-500" placeholder="123">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm mb-2" for="card-name">Name on Card</label>
                        <input type="text" id="card-name" name="card-name" class="w-full p-2 rounded bg-gray-700 text-white focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div id="paypal-form" class="payment-method-form hidden">
                    <div class="mb-4">
                        <label class="block text-sm mb-2" for="paypal-email">PayPal Email</label>
                        <input type="email" id="paypal-email" name="paypal-email" class="w-full p-2 rounded bg-gray-700 text-white focus:ring-2 focus:ring-blue-500" placeholder="example@paypal.com">
                    </div>
                </div>

                <div id="debit-card-form" class="payment-method-form hidden">
                    <div class="mb-4">
                        <label class="block text-sm mb-2" for="debit-card-number">Card Number</label>
                        <input type="text" id="debit-card-number" name="debit-card-number" class="w-full p-2 rounded bg-gray-700 text-white focus:ring-2 focus:ring-blue-500" placeholder="1234 5678 9012 3456">
                    </div>
                    <div class="flex gap-4 mb-4">
                        <div class="flex-1">
                            <label class="block text-sm mb-2" for="debit-expiry">Expiry Date</label>
                            <input type="text" id="debit-expiry" name="debit-expiry" class="w-full p-2 rounded bg-gray-700 text-white focus:ring-2 focus:ring-blue-500" placeholder="MM/YY">
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm mb-2" for="debit-cvv">CVV</label>
                            <input type="text" id="debit-cvv" name="debit-cvv" class="w-full p-2 rounded bg-gray-700 text-white focus:ring-2 focus:ring-blue-500" placeholder="123">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm mb-2" for="debit-card-name">Name on Card</label>
                        <input type="text" id="debit-card-name" name="debit-card-name" class="w-full p-2 rounded bg-gray-700 text-white focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div class="mb-4 text-gray-400 italic">
                    <p>Insurance options coming soon!</p>
                </div>

                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-full transition-all duration-200 transform hover:scale-105">Pay Now</button>
            </form>
        </section>
    </main>

    <!-- Invoice Modal -->
    <div id="invoice-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 w-full max-w-2xl mx-4 rounded-xl shadow-2xl transform transition-all fade-in">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-blue-400">Transaction Invoice</h2>
                    <button id="close-invoice" class="text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="border-t border-gray-700 pt-4">
                    <div class="flex justify-between mb-4">
                        <span class="text-gray-400">Invoice #:</span>
                        <span id="invoice-number" class="font-mono"></span>
                    </div>
                    <div class="flex justify-between mb-4">
                        <span class="text-gray-400">Date:</span>
                        <span id="invoice-date"></span>
                    </div>
                    <div class="border-t border-gray-700 py-4">
                        <h3 class="text-xl font-semibold mb-4" id="invoice-vehicle-name"></h3>
                        <div id="invoice-rental-details" class="hidden mb-4">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Rental Duration:</span>
                                <span id="invoice-rental-days"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Daily Rate:</span>
                                <span id="invoice-daily-rate"></span>
                            </div>
                        </div>
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-400">Payment Method:</span>
                            <span id="invoice-payment-method"></span>
                        </div>
                        <div class="flex justify-between font-bold text-xl mt-4 pt-4 border-t border-gray-700">
                            <span>Total Amount:</span>
                            <span id="invoice-total" class="text-blue-400"></span>
                        </div>
                    </div>
                </div>
                <div class="mt-6 text-center">
                    <button id="download-invoice" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-full transition-all duration-200 mr-4">
                        Download PDF
                    </button>
                    <button id="close-invoice-btn" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-full transition-all duration-200">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-gray-800 p-4 text-center shadow-inner">
        <p class="text-gray-300">© 2025 Motorverse</p>
    </footer>

    <script src="/script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let totalCost = 0;
            let vehicleRentalCost = 0;
            let insuranceCost = 0;
            const insurance_map = {'No Insurance': 'NONE',
             'Basic Coverage': 'BASIC', 
            'Premium Coverage': 'PREMIUM',
            'Comprehensive Coverage': 'COMPREHENSIVE'};

            // Check for insurance selection
            const selectedInsurance = JSON.parse(localStorage.getItem('selectedInsurance') || 'null');
            
            // Check for pending cart purchase
            const pendingCartPurchase = JSON.parse(localStorage.getItem('pendingCartPurchase') || 'null');
            
            // Check for single auto part purchase
            const pendingPurchase = JSON.parse(localStorage.getItem('pendingPurchase') || 'null');
            
            const urlParams = new URLSearchParams(window.location.search);
            const listingId = urlParams.get('listingId');
            const days = urlParams.get('days');
            const type = urlParams.get('type');
            const source = urlParams.get('source');

            // Handle cart purchases
            if (source === 'cart' && pendingCartPurchase) {
                // Display cart details
                document.getElementById('vehicle-name').textContent = "Shopping Cart Items";
                document.getElementById('vehicle-price').textContent = `Total Items: ${pendingCartPurchase.totalItems}`;
                
                // Show quantity information
                const rentalDaysElem = document.getElementById('rental-days');
                rentalDaysElem.innerHTML = `
                    <div class="mt-3 border-t border-gray-700 pt-3">
                        <h3 class="text-lg font-semibold mb-2">Cart Contents:</h3>
                        <div class="space-y-2">
                            ${pendingCartPurchase.items.map(item => `
                                <div class="flex justify-between">
                                    <span>${item.name} × ${item.quantity}</span>
                                    <span class="text-green-400">$${(item.price * item.quantity).toFixed(2)}</span>
                                </div>
                            `).join('')}

                        </div>
                    </div>
                `;
                rentalDaysElem.classList.remove('hidden');
                
                // Set total cost
                totalCost = pendingCartPurchase.totalAmount;
                document.getElementById('total-cost').textContent = `$${totalCost.toFixed(2)}`;
            }
            // Handle single auto part purchase
            else if (pendingPurchase && pendingPurchase.type === 'AUTOPART') {
                // Display auto part details
                document.getElementById('vehicle-name').textContent = pendingPurchase.name;
                document.getElementById('vehicle-price').textContent = `Price per unit: $${pendingPurchase.price.toFixed(2)}`;
                
                // Show quantity information
                const rentalDaysElem = document.getElementById('rental-days');
                rentalDaysElem.textContent = `Quantity: ${pendingPurchase.quantity} units`;
                rentalDaysElem.classList.remove('hidden');
                
                // Set total cost
                totalCost = pendingPurchase.totalAmount;
                document.getElementById('total-cost').textContent = `$${totalCost.toFixed(2)}`;
            } 
            // Handle vehicle purchase/rental
            else if (listingId) {
                fetch(`/api/listings/${listingId}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Listing not found');
                        return response.json();
                    })
                    .then(listing => {
                        document.getElementById('vehicle-name').textContent = `${listing.name} ${listing.year}`;
                        if (type === 'rent' && days) {
                            document.getElementById('vehicle-price').textContent = `Rent Rate: $${listing.rentRate.toFixed(2)}/day`;
                            document.getElementById('rental-days').textContent = `Rental Duration: ${days} day${days > 1 ? 's' : ''}`;
                            document.getElementById('rental-days').classList.remove('hidden');
                            
                            vehicleRentalCost = listing.rentRate * parseInt(days);
                            totalCost = vehicleRentalCost;
                            
                            // Add insurance details if selected
                            if (selectedInsurance && selectedInsurance.type !== 'none') {
                                const insuranceInfo = document.getElementById('insurance-info');
                                const insuranceName = document.getElementById('insurance-name');
                                const insuranceCostElement = document.getElementById('insurance-cost');
                                
                                insuranceName.textContent = selectedInsurance.name;
                                insuranceCostElement.textContent = `$${selectedInsurance.totalCost.toFixed(2)}`;
                                insuranceInfo.classList.remove('hidden');
                                
                                insuranceCost = selectedInsurance.totalCost;
                                totalCost += insuranceCost;
                            }
                        } else {
                            document.getElementById('vehicle-price').textContent = `Vehicle Price: $${listing.price.toFixed(2)}`;
                            totalCost = listing.price;
                        }
                        document.getElementById('total-cost').textContent = `$${totalCost.toFixed(2)}`;
                    })
                    .catch(error => {
                        console.error('Error fetching listing:', error);
                        document.getElementById('vehicle-name').textContent = 'Error loading vehicle';
                        document.getElementById('vehicle-price').textContent = 'N/A';
                        document.getElementById('total-cost').textContent = '$0.00';
                    });
            } else {
                document.getElementById('vehicle-name').textContent = 'No item selected';
                document.getElementById('vehicle-price').textContent = 'N/A';
            }

            // Payment method toggle code
            const toggles = {
                'credit-card': document.getElementById('credit-card-toggle'),
                'paypal': document.getElementById('paypal-toggle'),
                'debit-card': document.getElementById('debit-card-toggle')
            };
            const forms = {
                'credit-card': document.getElementById('credit-card-form'),
                'paypal': document.getElementById('paypal-form'),
                'debit-card': document.getElementById('debit-card-form')
            };
            let activeMethod = 'credit-card';

            function setActivePayment(method) {
                activeMethod = method;
                Object.keys(toggles).forEach(key => {
                    toggles[key].classList.toggle('active', key === method);
                    forms[key].classList.toggle('hidden', key !== method);
                });
            }

            toggles['credit-card'].addEventListener('click', () => setActivePayment('credit-card'));
            toggles['paypal'].addEventListener('click', () => setActivePayment('paypal'));
            toggles['debit-card'].addEventListener('click', () => setActivePayment('debit-card'));

            setActivePayment('credit-card');

            document.getElementById('payment-form').addEventListener('submit', async (e) => {
                e.preventDefault();
            
            function validate_credit_card(cardNumber, expiry, cvv) {
                // Basic validation for credit card fields
                const cardNumberPattern = /^\d{4} \d{4} \d{4} \d{4}$/;
                const expiryPattern = /^(0[1-9]|1[0-2])\/\d{2}$/;
                const cvvPattern = /^\d{3}$/;

                //if expiry is before current date, return false
                const [month, year] = expiry.split('/').map(Number);
                const currentDate = new Date();
                const currentMonth = currentDate.getMonth() + 1; // Months are 0-indexed
                const currentYear = currentDate.getFullYear() % 100; // Get last two digits of the year
                if (year < currentYear || (year === currentYear && month < currentMonth)) {
                    alert('Card has expired. Please check the expiry date.');
                    return false;
                }

                if(!cardNumberPattern.test(cardNumber)) {
                    alert('Invalid card number format. Please use "XXXX XXXX XXXX XXXX" format.');
                    return false;
                }
                if(!expiryPattern.test(expiry)) {
                    alert('Invalid expiry date format. Please use "MM/YY" format.');
                    return false;
                }
                if(!cvvPattern.test(cvv)) {
                    alert('Invalid CVV format. Please use "XXX" format.');
                    return false;
                }
                
            
                return cardNumberPattern.test(cardNumber) && expiryPattern.test(expiry) && cvvPattern.test(cvv);
            }    

            function validate_debit_card(debitCardNumber, debitExpiry, debitCvv) {
                // Basic validation for debit card fields
                const debitCardNumberPattern = /^\d{4} \d{4} \d{4} \d{4}$/;
                const debitExpiryPattern = /^(0[1-9]|1[0-2])\/\d{2}$/;
                const debitCvvPattern = /^\d{3}$/;

                //if expiry is before current date, return false

                const [month, year] = debitExpiry.split('/').map(Number);
                const currentDate = new Date();
                const currentMonth = currentDate.getMonth() + 1; // Months are 0-indexed
                const currentYear = currentDate.getFullYear() % 100; // Get last two digits of the year
                if (year < currentYear || (year === currentYear && month < currentMonth)) {
                    alert('Card has expired. Please check the expiry date.');
                    return false;
                }

                if(!debitCardNumberPattern.test(debitCardNumber)) {
                    alert('Invalid debit card number format. Please use "XXXX XXXX XXXX XXXX" format.');
                    return false;
                }
                if(!debitExpiryPattern.test(debitExpiry)) {
                    alert('Invalid expiry date format. Please use "MM/YY" format.');
                    return false;
                }
                if(!debitCvvPattern.test(debitCvv)) {
                    alert('Invalid CVV format. Please use "XXX" format.');
                    return false;
                }


                return debitCardNumberPattern.test(debitCardNumber) && debitExpiryPattern.test(debitExpiry) && debitCvvPattern.test(debitCvv);
            }



                let isValid = false;
                if (activeMethod === 'credit-card') {
                    const cardNumber = document.getElementById('card-number').value.trim();
                    const expiry = document.getElementById('expiry').value.trim();
                    const cvv = document.getElementById('cvv').value.trim();
                    const cardName = document.getElementById('card-name').value.trim();
                    isValid = cardNumber && expiry && cvv && cardName;
                    if (!isValid) {
                        alert('Please fill all Credit Card fields.');
                        return;
                    }
                    // Validate credit card details
                    if (!validate_credit_card(cardNumber, expiry, cvv)) {
                        alert('Invalid credit card details. Please check and try again.');
                        return;
                    }


                } else if (activeMethod === 'paypal') {
                    const paypalEmail = document.getElementById('paypal-email').value.trim();
                    isValid = paypalEmail && /\S+@\S+\.\S+/.test(paypalEmail);
                    if (!isValid) {
                        alert('Please enter a valid PayPal email.');
                        return;
                    }
                } else if (activeMethod === 'debit-card') {
                    const debitCardNumber = document.getElementById('debit-card-number').value.trim();
                    const debitExpiry = document.getElementById('debit-expiry').value.trim();
                    const debitCvv = document.getElementById('debit-cvv').value.trim();
                    const debitCardName = document.getElementById('debit-card-name').value.trim();
                    isValid = debitCardNumber && debitExpiry && debitCvv && debitCardName;
                    if (!isValid) {
                        alert('Please fill all Debit Card fields.');
                        return;
                    }

                    // Validate debit card details
                    if (!validate_debit_card(debitCardNumber, debitExpiry, debitCvv)) {
                        alert('Invalid debit card details. Please check and try again.');
                        return;
                    }
                }

                try {
                    const userId = parseInt(localStorage.getItem('userId'));
                    if (!userId) {
                        throw new Error('User not logged in');
                    }

                    // Handle cart purchases
                    if (source === 'cart' && pendingCartPurchase) {
                        // Processing cart items one by one
                        const cartResults = [];
                        
                        // Process each item in the cart
                        for (const item of pendingCartPurchase.items) {
                            try {
                                const endpoint = `/api/autoparts/${item.id}/purchase?quantity=${item.quantity}`;
                                console.log(`Processing cart item: ${item.name}, Quantity: ${item.quantity}`);
                                
                                const response = await fetch(endpoint, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    }
                                });
                                
                                if (!response.ok) {
                                    throw new Error(`Failed to process item: ${item.name}`);
                                }
                                
                                const result = await response.json();
                                cartResults.push({
                                    item: item.name,
                                    success: true,
                                    result
                                });
                            } catch (itemError) {
                                console.error(`Error processing item ${item.name}:`, itemError);
                                cartResults.push({
                                    item: item.name,
                                    success: false,
                                    error: itemError.message
                                });
                            }
                        }
                        
                        // Check if all items were processed successfully
                        const allSuccess = cartResults.every(r => r.success);
                        
                        if (!allSuccess) {
                            throw new Error('Some items could not be processed. Please try again.');
                        }
                        
                        console.log('Cart purchase successful:', cartResults);
                        
                        // Generate a reference number for the invoice
                        const invoiceNumber = 'CART-' + Math.random().toString(36).substr(2, 9).toUpperCase();
                        
                        // Update invoice details for cart
                        document.getElementById('invoice-number').textContent = invoiceNumber;
                        document.getElementById('invoice-date').textContent = new Date().toLocaleDateString();
                        document.getElementById('invoice-vehicle-name').textContent = "Shopping Cart Purchase";
                        document.getElementById('invoice-payment-method').textContent = activeMethod.replace('-', ' ').toUpperCase();
                        document.getElementById('invoice-total').textContent = `$${pendingCartPurchase.totalAmount.toFixed(2)}`;

                        // Add cart details to invoice
                        const rentalDetails = document.getElementById('invoice-rental-details');
                        rentalDetails.classList.remove('hidden');
                        rentalDetails.innerHTML = `
                            <div class="flex justify-between">
                                <span class="text-gray-400">Total Items:</span>
                                <span>${pendingCartPurchase.totalItems}</span>
                            </div>
                            <div class="mt-2 pt-2 border-t border-gray-700">
                                <h4 class="text-gray-400 mb-2">Items Purchased:</h4>
                                <div class="space-y-1">
                                    ${pendingCartPurchase.items.map(item => `
                                        <div class="flex justify-between text-sm">
                                            <span>${item.name} × ${item.quantity}</span>
                                            <span>$${(item.price * item.quantity).toFixed(2)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;

                        // Clear the cart after successful purchase
                        localStorage.removeItem('pendingCartPurchase');
                        localStorage.setItem('cart', '[]');
                    } 
                    // Handle single auto part purchase
                    else if (pendingPurchase && pendingPurchase.type === 'AUTOPART') {
                        // Endpoint for auto part payments - use PUT method to match controller
                        const endpoint = `/api/autoparts/${pendingPurchase.autoPartId}/purchase?quantity=${pendingPurchase.quantity}`;
                        console.log('Sending auto part payment data to', endpoint);

                        const response = await fetch(endpoint, {
                            method: 'PUT', 
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        console.log('Response status:', response.status);

                        if (!response.ok) {
                            const errorData = await response.text();
                            throw new Error(`Transaction failed: ${errorData}`);
                        }

                        const result = await response.json();
                        console.log('Auto part payment successful:', result);
                        
                        // Generate a reference number for the invoice
                        const invoiceNumber = 'AP-' + Math.random().toString(36).substr(2, 9).toUpperCase();
                        
                        // Update invoice details for auto parts
                        document.getElementById('invoice-number').textContent = invoiceNumber;
                        document.getElementById('invoice-date').textContent = new Date().toLocaleDateString();
                        document.getElementById('invoice-vehicle-name').textContent = pendingPurchase.name;
                        document.getElementById('invoice-payment-method').textContent = activeMethod.replace('-', ' ').toUpperCase();
                        document.getElementById('invoice-total').textContent = `$${pendingPurchase.totalAmount.toFixed(2)}`;

                        // Add quantity information to invoice
                        const rentalDetails = document.getElementById('invoice-rental-details');
                        rentalDetails.classList.remove('hidden');
                        document.getElementById('invoice-rental-days').textContent = `${pendingPurchase.quantity} units`;
                        document.getElementById('invoice-daily-rate').textContent = `$${pendingPurchase.price.toFixed(2)} per unit`;

                        // Clear the pending purchase
                        localStorage.removeItem('pendingPurchase');
                    } 
                    // Handle vehicle purchases/rentals
                    else {
                        const endpoint = '/api/listings/transaction';
                        const paymentData = {
                            userId: userId,
                            listingId: parseInt(listingId),
                            transactionType: type.toUpperCase(), // 'RENT' or 'BUY'
                            paymentMethod: activeMethod.toUpperCase().replace('-', '_'),
                            amount: totalCost,
                            ...(type === 'rent' ? { rentalDays: parseInt(days) } : {}), // Add days only for rent
                            
                            // Add insurance data if selected
                            ...(selectedInsurance && selectedInsurance.type !== 'none' ? { 
                                insurance: insurance_map[selectedInsurance.name] || 'NONE',
                                insuranceAmount: selectedInsurance.totalCost 
                            } : {})
                        };

                        console.log('Sending payment data to', endpoint, ':', paymentData);

                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(paymentData)
                        });

                        console.log('Response status:', response.status);

                        if (!response.ok) {
                            const errorData = await response.text();
                            throw new Error(`Transaction failed: ${errorData}`);
                        }

                        const result = await response.json();
                        console.log('Transaction successful:', result);
                        
                        // Generate random invoice number
                        const invoiceNumber = 'INV-' + Math.random().toString(36).substr(2, 9).toUpperCase();
                        
                        // Update invoice details
                        document.getElementById('invoice-number').textContent = invoiceNumber;
                        document.getElementById('invoice-date').textContent = new Date().toLocaleDateString();
                        document.getElementById('invoice-vehicle-name').textContent = document.getElementById('vehicle-name').textContent;
                        document.getElementById('invoice-payment-method').textContent = activeMethod.replace('-', ' ').toUpperCase();
                        document.getElementById('invoice-total').textContent = `$${totalCost.toFixed(2)}`;

                        if (type === 'rent') {
                            const rentalDetails = document.getElementById('invoice-rental-details');
                            rentalDetails.classList.remove('hidden');
                            
                            // Basic rental info
                            document.getElementById('invoice-rental-days').textContent = `${days} day${days > 1 ? 's' : ''}`;
                            document.getElementById('invoice-daily-rate').textContent = `$${(vehicleRentalCost / days).toFixed(2)}`;
                            
                            // Add insurance info to invoice if selected
                            if (selectedInsurance && selectedInsurance.type !== 'none') {
                                // Create insurance details in the invoice
                                const insuranceInfo = document.createElement('div');
                                insuranceInfo.className = 'flex justify-between mt-2 pt-2 border-t border-gray-700';
                                insuranceInfo.innerHTML = `
                                    <span class="text-gray-400">Insurance (${selectedInsurance.name}):</span>
                                    <span>$${insuranceCost.toFixed(2)}</span>
                                `;
                                rentalDetails.appendChild(insuranceInfo);
                            }
                        }
                        
                        // Clear the insurance selection after successful payment
                        localStorage.removeItem('selectedInsurance');
                    }

                    // Show invoice modal
                    const invoiceModal = document.getElementById('invoice-modal');
                    invoiceModal.classList.remove('hidden');

                    // Close modal handlers
                    const closeModal = () => {
                        invoiceModal.classList.add('hidden');
                        // Redirect based on purchase type
                        if (source === 'cart') {
                            window.location.href = '/auto-parts.html';
                        } else if (pendingPurchase && pendingPurchase.type === 'AUTOPART') {
                            window.location.href = '/auto-parts.html';
                        } else {
                            window.location.href = type === 'rent' ? '/rent-car.html' : '/buy-car.html';
                        }
                    };

                    const closeInvoice = document.getElementById('close-invoice');
                    const closeInvoiceBtn = document.getElementById('close-invoice-btn');
                    
                    closeInvoice.addEventListener('click', closeModal);
                    closeInvoiceBtn.addEventListener('click', closeModal);
                    document.getElementById('invoice-modal').addEventListener('click', (e) => {
                        if (e.target === document.getElementById('invoice-modal')) closeModal();
                    });

                    // Download PDF handler
                    document.getElementById('download-invoice').addEventListener('click', () => {
                        alert('PDF download feature coming soon!');
                    });

                } catch (error) {
                    console.error('Payment error:', error);
                    alert(`Payment failed: ${error.message}`);
                    if (error.message === 'User not logged in') {
                        window.location.href = `/login.html?redirect=${encodeURIComponent(window.location.pathname + window.location.search)}`;
                    }
                }
            });
        });
    </script>
</body>
</html>